{% extends 'base.html' %}
{% block content %}
{% set results = results|default({}) %}

<h2 class="mb-3">Serp Social Profile Finder</h2>
<p>
  Run Google searches via SerpAPI to find social-media profiles, then export a fully rendered CSV/Excel. 
  Queries can be generated from Countries × Sites, pasted, or uploaded as CSV. All input columns, including “query,” are carried over for easy sorting, and status/errors are recorded inline.
</p>

{% if results.error %}
  <div class="alert alert-danger" role="alert">
    {{ results.error }}
  </div>
{% endif %}

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link {% if (request.form.mode or 'preset') == 'preset' %}active{% endif %}" data-bs-toggle="tab" href="#preset">Preset (Countries × Sites)</a></li>
  <li class="nav-item"><a class="nav-link {% if request.form.mode == 'paste' %}active{% endif %}" data-bs-toggle="tab" href="#paste">Paste</a></li>
  <li class="nav-item"><a class="nav-link {% if request.form.mode == 'file' %}active{% endif %}" data-bs-toggle="tab" href="#file">Upload File</a></li>
</ul>

<div class="tab-content">

  <!-- PRESET -->
  <div class="tab-pane fade {% if (request.form.mode or 'preset') == 'preset' %}show active{% endif %}" id="preset">
    <form method="post" class="gy-3">
      <input type="hidden" name="mode" value="preset">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Countries (comma-separated)</label>
          <input type="text" class="form-control" name="countries" placeholder="China, Iran, Russia" value="{{ request.form.countries or 'China, Iran, Russia' }}">
          <div class="form-text">Used to generate queries against each site below.</div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Sites (comma-separated)</label>
          <input type="text" class="form-control" name="sites" placeholder="instagram.com, facebook.com, youtube.com, t.me, tiktok.com, threads.net" value="{{ request.form.sites or 'instagram.com, facebook.com, youtube.com, t.me, tiktok.com, threads.net' }}">
          <div class="form-text">Platform domains to target with <code>site:</code> filters.</div>
        </div>

        <div class="col-md-3">
          <label class="form-label">SerpAPI Key</label>
          <input type="password" class="form-control" name="api_key" placeholder="SERPAPI_KEY" value="{{ request.form.api_key or '' }}">
          <div class="form-text">If omitted, the server will use the <code>SERPAPI_KEY</code> environment variable.</div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Pages (×100)</label>
          <input type="number" class="form-control" name="page_limit" min="1" max="10" value="{{ request.form.page_limit or 3 }}">
          <div class="form-text">Each page fetches up to 100 results (max 10 pages).</div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Throttle (milliseconds)</label>
          <input type="number" class="form-control" name="throttle_ms" min="0" step="100" value="{{ request.form.throttle_ms or 1000 }}">
          <div class="form-text">Delay between page fetches to be polite.</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Output</label>
          <div class="d-flex gap-3 pt-2">
            {% set om = request.form.output_mode %}
            <div class="form-check">
              <input class="form-check-input" type="radio" name="output_mode" id="table0" value="table" {% if om != 'excel' and om != 'csv' %}checked{% endif %}>
              <label class="form-check-label" for="table0">Table (on-page)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="output_mode" id="excel0" value="excel" {% if om == 'excel' %}checked{% endif %}>
              <label class="form-check-label" for="excel0">Download Excel</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="output_mode" id="csv0" value="csv" {% if om == 'csv' %}checked{% endif %}>
              <label class="form-check-label" for="csv0">Download CSV</label>
            </div>
          </div>
        </div>

        <div class="col-12">
          <details class="mt-1">
            <summary class="mb-2">Advanced Google parameters</summary>
            <div class="row g-3 mt-1">
              <div class="col-md-3">
                <label class="form-label">google_domain</label>
                <input type="text" class="form-control" name="google_domain" placeholder="google.com" value="{{ request.form.google_domain or 'google.com' }}">
              </div>
              <div class="col-md-2">
                <label class="form-label">gl</label>
                <input type="text" class="form-control" name="gl" placeholder="us" value="{{ request.form.gl or 'us' }}">
              </div>
              <div class="col-md-2">
                <label class="form-label">hl</label>
                <input type="text" class="form-control" name="hl" placeholder="en" value="{{ request.form.hl or 'en' }}">
              </div>
              <div class="col-md-5">
                <label class="form-label">location</label>
                <input type="text" class="form-control" name="location" placeholder="United States" value="{{ request.form.location or 'United States' }}">
              </div>
            </div>
          </details>
        </div>
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Run Preset Searches</button>
      </div>
    </form>
  </div>

  <!-- PASTE -->
  <div class="tab-pane fade {% if request.form.mode == 'paste' %}show active{% endif %}" id="paste">
    <form method="post">
      <input type="hidden" name="mode" value="paste">
      <div class="mb-3">
        <label class="form-label">Paste CSV rows or free-text</label>
        <textarea class="form-control" name="pasted" rows="8" placeholder="Examples:
query
&quot;China state-controlled media&quot; site:facebook.com
&quot;Iran state-affiliated media&quot; site:tiktok.com

— or —

country,site
China, facebook.com
Russia, youtube.com
">{{ request.form.pasted or '' }}</textarea>
        <div class="form-text">
          If a <code>query</code> column is present, it will be used as-is. Otherwise, if <code>country</code> and <code>site</code> exist, the app will construct queries for you.
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">SerpAPI Key</label>
          <input type="password" class="form-control" name="api_key" placeholder="SERPAPI_KEY" value="{{ request.form.api_key or '' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Pages (×100)</label>
          <input type="number" class="form-control" name="page_limit" min="1" max="10" value="{{ request.form.page_limit or 3 }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Throttle (milliseconds)</label>
          <input type="number" class="form-control" name="throttle_ms" min="0" step="100" value="{{ request.form.throttle_ms or 1000 }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Output</label>
          <div class="d-flex gap-3 pt-2">
            {% set om1 = request.form.output_mode %}
            <div class="form-check">
              <input class="form-check-input" type="radio" name="output_mode" id="table1" value="table" {% if om1 != 'excel' and om1 != 'csv' %}checked{% endif %}>
              <label class="form-check-label" for="table1">Table (on-page)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="output_mode" id="excel1" value="excel" {% if om1 == 'excel' %}checked{% endif %}>
              <label class="form-check-label" for="excel1">Download Excel</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="output_mode" id="csv1" value="csv" {% if om1 == 'csv' %}checked{% endif %}>
              <label class="form-check-label" for="csv1">Download CSV</label>
            </div>
          </div>
        </div>
      </div>

      <details class="mt-3">
        <summary class="mb-2">Advanced Google parameters</summary>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">google_domain</label>
            <input type="text" class="form-control" name="google_domain" placeholder="google.com" value="{{ request.form.google_domain or 'google.com' }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">gl</label>
            <input type="text" class="form-control" name="gl" placeholder="us" value="{{ request.form.gl or 'us' }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">hl</label>
            <input type="text" class="form-control" name="hl" placeholder="en" value="{{ request.form.hl or 'en' }}">
          </div>
          <div class="col-md-5">
            <label class="form-label">location</label>
            <input type="text" class="form-control" name="location" placeholder="United States" value="{{ request.form.location or 'United States' }}">
          </div>
        </div>
      </details>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Run Pasted Searches</button>
      </div>
    </form>
  </div>

  <!-- FILE -->
  <div class="tab-pane fade {% if request.form.mode == 'file' %}show active{% endif %}" id="file">
    <form method="post" enctype="multipart/form-data">
      <input type="hidden" name="mode" value="file">
      <div class="mb-3">
        <label class="form-label">Upload .csv or .txt</label>
        <input type="file" class="form-control" name="file" accept=".csv,.txt,text/csv,text/plain">
        <div class="form-text">
          CSV with a <code>query</code> column is preferred. Alternatively, include <code>country</code> and <code>site</code> columns, or provide plaintext with one “query” per line.
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">SerpAPI Key</label>
          <input type="password" class="form-control" name="api_key" placeholder="SERPAPI_KEY" value="{{ request.form.api_key or '' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Pages (×100)</label>
          <input type="number" class="form-control" name="page_limit" min="1" max="10" value="{{ request.form.page_limit or 3 }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Throttle (milliseconds)</label>
          <input type="number" class="form-control" name="throttle_ms" min="0" step="100" value="{{ request.form.throttle_ms or 1000 }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Output</label>
          <div class="d-flex gap-3 pt-2">
            {% set om2 = request.form.output_mode %}
            <div class="form-check">
              <input class="form-check-input" type="radio" name="output_mode" id="table2" value="table" {% if om2 != 'excel' and om2 != 'csv' %}checked{% endif %}>
              <label class="form-check-label" for="table2">Table (on-page)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="output_mode" id="excel2" value="excel" {% if om2 == 'excel' %}checked{% endif %}>
              <label class="form-check-label" for="excel2">Download Excel</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="output_mode" id="csv2" value="csv" {% if om2 == 'csv' %}checked{% endif %}>
              <label class="form-check-label" for="csv2">Download CSV</label>
            </div>
          </div>
        </div>
      </div>

      <details class="mt-3">
        <summary class="mb-2">Advanced Google parameters</summary>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">google_domain</label>
            <input type="text" class="form-control" name="google_domain" placeholder="google.com" value="{{ request.form.google_domain or 'google.com' }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">gl</label>
            <input type="text" class="form-control" name="gl" placeholder="us" value="{{ request.form.gl or 'us' }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">hl</label>
            <input type="text" class="form-control" name="hl" placeholder="en" value="{{ request.form.hl or 'en' }}">
          </div>
          <div class="col-md-5">
            <label class="form-label">location</label>
            <input type="text" class="form-control" name="location" placeholder="United States" value="{{ request.form.location or 'United States' }}">
          </div>
        </div>
      </details>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Run File Searches</button>
      </div>
    </form>
  </div>
</div>

{% if results.table_rows is defined and results.table_rows %}
  <hr class="my-4">

  <h5 class="mb-2">Results</h5>
  <ul class="list-unstyled small text-muted">
    <li>Rows: {{ results.total_rows }}</li>
    <li>OK: {{ results.ok_rows }}</li>
    <li>No Results: {{ results.no_results_rows }}</li>
    <li>Errors: {{ results.error_rows }}</li>
    <li>Queries Submitted: {{ results.queries_submitted }}</li>
    <li>Queries With Results: {{ results.queries_with_results }}</li>
  </ul>

  <div class="table-responsive">
    <table id="resultsTable" class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          {# Build headers dynamically from the first row's keys #}
          {% set cols = results.table_rows[0].keys() %}
          {% for col in cols %}
            <th class="sortable" data-col="{{ col|e }}">{{ col }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in results.table_rows %}
          <tr>
            {% for col in cols %}
              {% set val = row[col] %}
              {% if val is string and val.startswith('http') %}
                <td style="max-width: 420px; word-break: break-all;">
                  <a href="{{ val }}" target="_blank" rel="noopener">{{ val }}</a>
                </td>
              {% else %}
                <td>{{ val if val is not none else '' }}</td>
              {% endif %}
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <p class="small text-muted">Tip: Click a column header to sort. Use CSV/Excel export for heavy analysis.</p>
{% endif %}

{# Minimal client-side sorting (no dependency) #}
<script>
(function () {
  const table = document.getElementById('resultsTable');
  if (!table) return;

  const getCellVal = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;

  const comparer = (idx, asc) => (a, b) => {
    const v1 = getCellVal(asc ? a : b, idx).trim();
    const v2 = getCellVal(asc ? b : a, idx).trim();

    // Numeric compare when possible
    const n1 = parseFloat(v1.replace(/,/g, ''));
    const n2 = parseFloat(v2.replace(/,/g, ''));
    if (!isNaN(n1) && !isNaN(n2)) return n1 - n2;

    // Date compare (ISO)
    const d1 = Date.parse(v1);
    const d2 = Date.parse(v2);
    if (!isNaN(d1) && !isNaN(d2)) return d1 - d2;

    return v1.localeCompare(v2);
  };

  table.querySelectorAll('th.sortable').forEach((th, idx) => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', function () {
      const tbody = table.tBodies[0];
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const asc = !this.classList.contains('asc');
      table.querySelectorAll('th.sortable').forEach(h => h.classList.remove('asc','desc'));
      this.classList.add(asc ? 'asc' : 'desc');
      rows.sort(comparer(idx, asc)).forEach(tr => tbody.appendChild(tr));
    });
  });
})();
</script>

{% endblock %}
