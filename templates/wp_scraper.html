{% extends 'base.html' %}
{% block content %}
{% set results = results|default({}) %}

<h2 class="mb-4 d-flex align-items-center gap-2">
  <i class="fa-solid fa-newspaper text-dark"></i>
  WordPress Article Scraper
</h2>
<p>Scrape articles from any WordPress site via its REST API. Optionally resolve author, category, and tag names using “_embed.”</p>

<form method="post" class="mb-4">
  <div class="soft-card p-3 mb-3">
    <label class="form-label">Site URL Or Full REST Endpoint</label>
    <input type="text" name="site_input" class="form-control" placeholder="https://example.com  or  https://example.com/wp-json/wp/v2/posts" value="{{ request.form.site_input or '' }}" required>
    <div class="form-text">If you provide a site URL, we will use “/wp-json/wp/v2/posts.”</div>
  </div>

  <div class="soft-card p-3 mb-3">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Search (optional)</label>
        <input type="text" name="search" class="form-control" placeholder="Keyword or phrase" value="{{ request.form.search or '' }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">After (UTC)</label>
        <input type="date" name="after" class="form-control" value="{{ request.form.after or '' }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Before (UTC)</label>
        <input type="date" name="before" class="form-control" value="{{ request.form.before or '' }}">
      </div>
    </div>
  </div>

  <div class="soft-card p-3 mb-3">
    <div class="row g-3">
      <div class="col-md-2">
        <label class="form-label">Per Page</label>
        <input type="number" name="per_page" class="form-control" min="1" max="100" value="{{ request.form.per_page or 100 }}">
        <div class="form-text">Max 100.</div>
      </div>
      <div class="col-md-2">
        <label class="form-label">Max Pages</label>
        <input type="number" name="max_pages" class="form-control" min="1" max="500" value="{{ request.form.max_pages or 50 }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Sleep (seconds)</label>
        <input type="number" step="0.1" name="sleep_s" class="form-control" min="0" value="{{ request.form.sleep_s or 0.5 }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Language (optional)</label>
        <input type="text" name="lang" class="form-control" placeholder="e.g., en, es" value="{{ request.form.lang or '' }}">
        <div class="form-text">For multilingual plugins that honor “lang”.</div>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <div class="form-check me-4">
          <input class="form-check-input" type="checkbox" name="resolve_names" id="resolve_names" {% if request.form.resolve_names %}checked{% endif %}>
          <label class="form-check-label" for="resolve_names">Resolve Author/Category/Tag Names (_embed)</label>
        </div>
        <div class="ms-auto">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="output_mode" id="table" value="table" {% if request.form.output_mode != 'excel' %}checked{% endif %}>
            <label class="form-check-label" for="table">Table</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="output_mode" id="excel" value="excel" {% if request.form.output_mode == 'excel' %}checked{% endif %}>
            <label class="form-check-label" for="excel">Excel</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button class="btn btn-primary" type="submit">Scrape</button>
</form>

{% if results.error %}
  <div class="alert alert-danger">{{ results.error }}</div>
{% endif %}

{% if results.ok %}
  <div class="mt-4">
    <h5 class="mb-2">Summary</h5>
    <ul>
      <li>Endpoint: {{ results.meta.endpoint }}</li>
      <li>Collected Articles: {{ results.collected }}</li>
      <li>WP Total Header: {{ results.meta.total_items_header or '—' }}, Pages: {{ results.meta.total_pages_header or '—' }}</li>
    </ul>

    {% if results.preview and results.preview|length > 0 %}
    <h6 class="mt-3">Preview (first 100 rows)</h6>
    <div class="table-responsive">
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>ID</th><th>Date</th><th>Title</th><th>Author</th><th>Categories</th><th>Tags</th><th>Link</th>
          </tr>
        </thead>
        <tbody>
          {% for r in results.preview %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.date }}</td>
            <td>{{ r.title }}</td>
            <td>{{ r.author_name or r.author_id }}</td>
            <td>{{ r.categories or r.category_ids }}</td>
            <td>{{ r.tags or r.tag_ids }}</td>
            <td><a href="{{ r.link }}" target="_blank" rel="noreferrer">Open</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p class="text-muted">No posts found for that query.</p>
    {% endif %}
  </div>
{% endif %}

{% endblock %}
