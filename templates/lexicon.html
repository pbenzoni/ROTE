{% extends "base.html" %}
{% block content %}
<h2>Lexical/Sentiment Analysis</h2>

<form method="post" enctype="multipart/form-data">
  <!-- Language selector -->
  <div class="mb-3">
    <label class="form-label">Language</label>
    {% set current_lang = request.form.lang or 'en' %}
    <select name="lang" class="form-select">
      <option value="en" {% if current_lang == 'en' %}selected{% endif %}>English</option>
      <option value="es" {% if current_lang == 'es' %}selected{% endif %}>Español</option>
    </select>
    <div class="form-text">
      English uses VADER for sentiment; Spanish uses a lightweight, lexicon-based negative-intensity score.
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">CSV OR Excel File</label>
    <input type="file" name="csv_file" class="form-control" accept=".csv,.xlsx,.xlsm,.xlsb,.xls">
  </div>
  <div class="mb-3">
    <label class="form-label">Text Column to Analyze</label>
    <input name="text_column" class="form-control" value="{{ request.form.text_column or '' }}">
  </div>

  <!-- NEW: Optional HTML column for XPath-based parsing -->
  <div class="mb-3">
    <label class="form-label">HTML Column (optional)</label>
    <input name="html_column" class="form-control" value="{{ request.form.html_column or '' }}" placeholder="e.g., article_html">
    <div class="form-text">
      If provided, embedded links and tweets will be extracted using XPath. Requires lxml.
    </div>
  </div>

  <div class="mb-3">
  <label class="form-label">Filter (optional)</label>
  <textarea name="filter_query" class="form-control" rows="2" placeholder="e.g., ukraine, nato">{{ request.form.filter_query or '' }}</textarea>
  <div class="form-text">
    Only rows whose text contains the terms will be analyzed. Separate terms with commas or new lines.
  </div>
</div>
<div class="row g-3 mb-3">
  <div class="col-md-3">
    <label class="form-label">Filter Logic</label>
    {% set fl = (request.form.filter_logic or 'any') %}
    <select name="filter_logic" class="form-select">
      <option value="any" {% if fl=='any' %}selected{% endif %}>Match any term</option>
      <option value="all" {% if fl=='all' %}selected{% endif %}>Match all terms</option>
    </select>
  </div>
  <div class="col-md-3 d-flex align-items-end">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="filter_regex" name="filter_regex" {% if request.form.filter_regex %}checked{% endif %}>
      <label class="form-check-label" for="filter_regex">Treat terms as regular expressions</label>
    </div>
  </div>
</div>
  <div class="mb-3">
    <label class="form-label">Group-By Column (optional)</label>
    <input name="group_column" class="form-control" value="{{ request.form.group_column or '' }}">
  </div>

  <!-- NEW: NLP feature toggles -->
  <div class="mb-3">
    <label class="form-label">Analysis Options</label>
    <div class="row">
      {% set et = request.form.get('enable_tokens', 'on') %}
      {% set ee = request.form.get('enable_entities', 'on') %}
      {% set es = request.form.get('enable_sentiment', 'on') %}
      {% set esp = request.form.get('enable_social_profiles', 'on') %}
      {% set ekp = request.form.get('enable_key_phrases', 'on') %}
      <div class="col-md-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="enable_tokens" name="enable_tokens" {% if et %}checked{% endif %}>
          <label class="form-check-label" for="enable_tokens">Enable tokens & term frequencies</label>
        </div>
      </div>
      <div class="col-md-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="enable_entities" name="enable_entities" {% if ee %}checked{% endif %}>
          <label class="form-check-label" for="enable_entities">Enable entities (spaCy)</label>
        </div>
        <div class="form-text">If disabled, entity extraction is skipped and spaCy is not loaded.</div>
      </div>
      <div class="col-md-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="enable_sentiment" name="enable_sentiment" {% if es %}checked{% endif %}>
          <label class="form-check-label" for="enable_sentiment">Enable sentiment</label>
        </div>
      </div>
      <!-- NEW: Social media profiles toggle -->
      <div class="col-md-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="enable_social_profiles" name="enable_social_profiles" {% if esp %}checked{% endif %}>
          <label class="form-check-label" for="enable_social_profiles">Extract social media profiles</label>
        </div>
        <div class="form-text">Parses URLs in text to capture Platform:Handle pairs.</div>
      </div>
      <!-- NEW: Key phrases toggle -->
      <div class="col-md-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="enable_key_phrases" name="enable_key_phrases" {% if ekp %}checked{% endif %}>
          <label class="form-check-label" for="enable_key_phrases">Extract key phrases (KeyBERT)</label>
        </div>
        <div class="form-text">Uses KeyBERT to extract meaningful phrases from text.</div>
      </div>
    </div>
  </div>

  <button class="btn btn-primary" type="submit">Display Analysis in Browser</button>
  <button name="format" value="excel" class="btn btn-secondary" type="submit">Download Analysis as Excel</button>
</form>

{% if results.group_freqs %}
  <h4 class="mt-4">Top Terms per Group</h4>
  {% for group, summary in results.group_freqs.items() %}
    <div class="mb-3">
      <h5>{{ group }}</h5>
      <div>
        <strong>Total Token Equivalents:</strong> {{ summary.total_token_equivalents }}
      </div>
      <div class="row">
        <div class="col-md-6">
          <h6>Top Normalized Terms (per-thousand rate)</h6>
          <table class="table table-sm">
            <thead><tr><th>Term</th><th>Normalized</th></tr></thead>
            <tbody>
              {% for term, val in summary.top_normalized.items() %}
                <tr><td>{{ term }}</td><td>{{ val }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="col-md-6">
          <h6>Top Raw Terms</h6>
          <table class="table table-sm">
            <thead><tr><th>Term</th><th>Count</th></tr></thead>
            <tbody>
              {% for term, val in summary.top_raw.items() %}
                <tr><td>{{ term }}</td><td>{{ val }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% if results.meta and results.meta[group] %}
        <div class="mt-2">
          <h6>Meta Summary</h6>
          <div class="row">
            <div class="col-md-2">
              <strong>Mentions</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group].mentions.items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            <div class="col-md-2">
              <strong>Hashtags</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group].hashtags.items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            <div class="col-md-2">
              <strong>Links</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group].links.items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            <div class="col-md-2">
              <strong>Domains</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group].domains.items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            <div class="col-md-2">
              <strong>Entities</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group].entities.items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>

            <!-- NEW: Key phrases -->
            {% if 'key_phrases' in results.meta[group] %}
            <div class="col-md-2">
              <strong>Key Phrases</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group]['key_phrases'].items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <!-- NEW: Embedded links (XPath) -->
            {% if 'embedded_links_xpath' in results.meta[group] %}
            <div class="col-md-2">
              <strong>Embedded Links (XPath)</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group]['embedded_links_xpath'].items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <!-- NEW: Tweet IDs -->
            {% if 'tweet_ids' in results.meta[group] %}
            <div class="col-md-2">
              <strong>Tweet IDs</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group]['tweet_ids'].items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <!-- NEW: Tweet Screen Names -->
            {% if 'tweet_screen_names' in results.meta[group] %}
            <div class="col-md-2">
              <strong>Tweet Screen Names</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group]['tweet_screen_names'].items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <!-- NEW: Social Profiles (Platform:Handle pairs) -->
            {% if 'social_profile_pairs' in results.meta[group] %}
            <div class="col-md-2">
              <strong>Social Profiles</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group]['social_profile_pairs'].items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <!-- NEW: Social Platforms (Platform counts) -->
            {% if 'social_platforms' in results.meta[group] %}
            <div class="col-md-2">
              <strong>Social Platforms</strong>
              <ul class="list-unstyled">
                {% for term, count in results.meta[group]['social_platforms'].items() %}
                  <li>{{ term }}: {{ count }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
    <hr/>
  {% endfor %}
{% endif %}

{% if results.differential %}
  <h4 class="mt-4">Differential ({{ results.differential_groups[0] }} vs {{ results.differential_groups[1] }})</h4>
  <p>
    Columns explanation: Raw counts show absolute occurrences, normalized values are per-thousand-token-equivalent rates to adjust for volume differences, 
    <strong>differential_norm</strong> is the difference between normalized rates (first group minus second), so positive means relatively more prevalent in the first group.
  </p>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>Term</th>
        <th>{{ results.differential_groups[0] }} Raw</th>
        <th>{{ results.differential_groups[1] }} Raw</th>
        <th>{{ results.differential_groups[0] }} Norm</th>
        <th>{{ results.differential_groups[1] }} Norm</th>
        <th>Normalized Differential</th>
      </tr>
    </thead>
    <tbody>
      {% for row in results.differential %}
        <tr>
          <td>{{ row.term }}</td>
          <td>{{ row[results.differential_groups[0] + "_raw"] }}</td>
          <td>{{ row[results.differential_groups[1] + "_raw"] }}</td>
          <td>{{ row[results.differential_groups[0] + "_norm"] }}</td>
          <td>{{ row[results.differential_groups[1] + "_norm"] }}</td>
          <td>{{ row.differential_norm }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

{% if results.sentiment_summary %}
  <h4 class="mt-4">Sentiment Summary</h4>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>Group</th>
        <th>Count Nonzero</th>
        <th>Mean Negative Intensity</th>
        <th>95% CI</th>
      </tr>
    </thead>
    <tbody>
      {% for r in results.sentiment_summary %}
        <tr>
          <td>{{ r['group'] }}</td>
          <td>{{ r['count_nonzero'] }}</td>
          <td>{{ "%.3f"|format(r['mean_neg_intensity']) }}</td>
          <td>{{ "%.3f"|format(r['95ci_lower']) }} – {{ "%.3f"|format(r['95ci_upper']) }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}
{% endblock %}
